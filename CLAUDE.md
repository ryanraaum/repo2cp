# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Package Overview

**repo2cp** is an R package that converts bibliographic data from multiple sources (Crossref, PubMed, OpenAlex, BibTeX) into citeproc-compatible formats (citeproc-json and an internal "edb-list" format).

**Core Purpose**: This package is fundamentally a collection of helper functions to get online bibliographic data into an [erudiciondb](https://github.com/ryanraaum/erudiciondb) database. The "edb-list" format is designed as a direct structural match to the erudiciondb schema.

## Development Commands

### Testing
```r
# Run all tests
devtools::test()

# Run specific test file
testthat::test_file("tests/testthat/test-crossref.R")

# Run tests with coverage
covr::package_coverage()
```

### Building & Checking
```r
# Build package documentation
devtools::document()

# Check package
devtools::check()

# Install package locally
devtools::install()

# Load for interactive development
devtools::load_all()
```

### Data Generation
```r
# Regenerate internal data (CSL mappings, type conversions)
source("data-raw/internal_data.R")

# Regenerate package data (example objects)
source("data-raw/package_data.R")
```

## Architecture

### Core Processing Pipeline

Each source format has a dedicated converter function that follows a common pattern:

1. **Source-specific parser** (`crossref2cp()`, `pubmed2cp()`, `openalex2cp()`, `bibentry2cp()`)
   - Takes raw data from the source format
   - Extracts and normalizes fields into an intermediate "edb-list" format
   - edb-list structure: `list(item = ..., author = ..., author_affiliation = ..., author_identifier = ...)`

2. **Intermediate format** ("edb-list")
   - **Designed to match [erudiciondb](https://github.com/ryanraaum/erudiciondb) database structure**
   - R-friendly list with clean snake_case names
   - Separates core item metadata from creator data (authors/editors)
   - Allows for extended fields not in CSL spec (e.g., affiliations, identifiers)
   - This is the primary output format for database ingestion

3. **CSL conversion** (via `.edb2csl()` and `.unclean_csl_list()`)
   - Merges item + creator data into single list
   - Converts snake_case names back to CSL kebab-case
   - Optionally serializes to JSON via `cplist2json()`

### Type Mapping System

The package maintains mapping tables in `R/sysdata.rda` (generated by `data-raw/internal_data.R`):

- **crossref2csl**: Maps Crossref types to CSL types
- **bibtex2csl**: Maps BibTeX types to CSL types (with subtype support)
- **language3to2**: Converts ISO 639-2 (3-letter) to ISO 639-1 (2-letter) language codes
- **csl_core_clean** / **csl_creator_clean**: Valid CSL field names in snake_case
- **clean2csl** / **csl2clean**: Bidirectional name conversion mappings

These mappings are built from:
- CSL Data Schema v1.0 (`data-raw/csl-data-v1.0.json`)
- Custom mapping CSVs (`data-raw/crossref2csldata.csv`, `data-raw/bibtex2csldata.csv`)

### Source-Specific Details

**Crossref** (`R/crossref.R`):
- Handles institutional authors (uses `literal` field instead of `given`/`family`)
- Extracts ORCID identifiers and affiliations as separate elements
- Date handling prioritizes: `issued` → `published` → `published-print`

**PubMed** (`R/pubmed.R`):
- Parses XML using xml2
- Handles collective names (institutional authors)
- Reconciles DOI from multiple locations (ArticleIdList, ELocationID)
- Defaults to day=01, month=01 for missing date components

**OpenAlex** (`R/openalex.R`):
- Complex type resolution (uses both `type` and `location.type` fields)
- Uninverts abstract from inverted index representation
- Parses author names using humaniformat package

**BibTeX/bibentry** (`R/bibentry.R`):
- Works with base R `bibentry` objects (from bibtex package)
- Handles BibTeX subtypes (e.g., article-magazine, entry-encyclopedia)
- Resolves container_title from fjournal → journal → booktitle priority

## Key Utilities

- **xml_text_or_null()**: Safely extract text from XML nodesets (returns NULL for empty)
- **cplist2json()**: Convert R list to pretty-printed citeproc JSON
- **cjson()**: Combine multiple JSON objects into JSON array
- **.convert_language()**: Convert language codes (handles 2 and 3 letter codes)
- **.clean_doi()**: Extract DOI from string (handles full URLs)

## Testing Strategy

- Test files mirror source files: `test-crossref.R`, `test-pubmed.R`, etc.
- Tests use package data objects (e.g., `cr_journal_article`) to avoid hitting live APIs
- Parameterized tests loop over multiple data sources (RDA files, JSON files)
- Tests verify:
  - Function completes without error
  - Correct top-level structure (item, author, author_affiliation, author_identifier)
  - Only valid CSL fields present in results
  - Type mapping correctness

## Dependencies

Core parsing: xml2, jsonlite, purrr, dplyr, stringr, lubridate, glue
Special utilities: humaniformat (name parsing), janitor (name cleaning), aidr (existence checks)
Testing: testthat (>= 3.0.0)

**Note**: The `aidr` package is available at https://github.com/ryanraaum/aidr - refer there for more information about its helper functions.

## Notes

- The package uses `aidr::this_exists()` and `aidr::this_or_na()` helper functions extensively for safe field extraction
- All main converter functions support `format` parameter: "edb-list", "citeproc-list", "citeproc-json"
- Currently only Crossref fully implements all three return formats; others only support "edb-list"
- Package data in `data/` provides example objects for each source format for testing/demos
